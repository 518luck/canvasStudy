<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>五子棋</title>
    <style>
      canvas {
        background-color: #ffb077;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <script>
      let canvas = document.createElement('canvas')
      const dpr = window.devicePixelRatio || 1
      canvas.style.width = '600px'
      canvas.style.height = '600px'
      canvas.width = 600 * dpr
      canvas.height = 600 * dpr
      document.body.append(canvas)
      let ctx = canvas.getContext('2d')
      ctx.scale(dpr, dpr)

      // 五子棋的棋盘通常有196个格子。棋盘由14行和14列组成.
      const gridSize = 40 // 网格大小
      const startOffset = 20 // 起始偏移量
      const lineCouint = 15 // 线条数量
      for (let i = 1; i <= lineCouint; i++) {
        ctx.moveTo(20, i * gridSize - startOffset)
        ctx.lineTo(20 + 14 * gridSize, i * gridSize - startOffset)
      }

      for (let i = 1; i <= lineCouint; i++) {
        ctx.moveTo(i * gridSize - startOffset, 20)
        ctx.lineTo(i * gridSize - startOffset, 20 + 14 * gridSize)
      }
      ctx.stroke()

      const circles = new Array(15)
        .fill(null)
        .map(() => new Array(15).fill(null))

      let isBlack = true
      canvas.addEventListener('click', (e) => {
        let { offsetX, offsetY } = e

        let x =
          Math.round((offsetX - startOffset) / gridSize) * gridSize +
          startOffset

        let y =
          Math.round((offsetY - startOffset) / gridSize) * gridSize +
          startOffset

        const xIndex = Math.round((x - startOffset) / gridSize)
        const yIndex = Math.round((y - startOffset) / gridSize)
        if (circles[xIndex][yIndex]) return
        circles[xIndex][yIndex] = {
          x,
          y,
          color: isBlack ? 'black' : 'white',
        }

        ctx.beginPath()
        ctx.arc(x, y, 15, 0, Math.PI * 2)
        let tx = isBlack ? x - 2 : x + 2
        let ty = isBlack ? y - 2 : y + 2
        let gradient = ctx.createRadialGradient(tx, ty, 0, tx, ty, 15)

        gradient.addColorStop(0, isBlack ? '#ccc' : `#666`)
        gradient.addColorStop(1, isBlack ? '#000' : '#fff')
        ctx.shadowColor = '#000'
        ctx.shadowBlur = 20
        ctx.shadowOffsetX = 8
        ctx.shadowOffsetY = 8

        ctx.fillStyle = gradient
        ctx.fill()
        ctx.closePath()

        if (checkWin(xIndex, yIndex, isBlack ? 'black' : 'white')) {
          alert(isBlack ? '黑棋赢了' : '白棋赢了')
          return
        }

        isBlack = !isBlack
      })

      function checkWin(xIndex, yIndex, color) {
        const directions = [
          [1, 0],
          [0, 1],
          [1, 1],
          [1, -1],
        ]
        function isValidAndSameColor(nx, ny) {
          return (
            nx >= 0 &&
            nx < 15 &&
            ny >= 0 &&
            ny < 15 &&
            circles[nx][ny] &&
            circles[nx][ny].color === color
          )
        }
        for (const [dx, dy] of directions) {
          let count = 1

          for (let i = 1; i < 5; i++) {
            const nx = xIndex + dx * i
            const ny = yIndex + dy * i
            if (isValidAndSameColor(nx, ny)) {
              count++
            } else {
              break
            }
          }
          for (let i = 1; i < 5; i++) {
            const nx = xIndex - dx * i
            const ny = yIndex - dy * i
            if (isValidAndSameColor(nx, ny)) {
              count++
            } else {
              break
            }
          }

          if (count >= 5) {
            return true
          }
        }
        return false
      }
    </script>
  </body>
</html>
